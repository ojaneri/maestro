# System Patterns

## System Architecture

Maestro follows a distributed architecture with PHP as the web frontend and Node.js instances handling WhatsApp connections:

- **Web Layer**: PHP handles user authentication, instance management, and API endpoints
- **Instance Layer**: Node.js processes run individual WhatsApp sessions using Baileys library
- **Data Layer**: SQLite database serves as single source of truth
- **Communication**: HTTP/cURL between PHP and Node.js instances, WebSocket for real-time updates

## Key Technical Decisions

- **SQLite Database**: Chosen for portability and simplicity over MySQL, eliminating server dependencies
- **Instance-Based Architecture**: Each WhatsApp account runs in isolated Node.js process for stability
- **Proxy Pattern**: PHP proxies API calls to appropriate Node.js instances based on instance ID
- **Settings Storage**: Instance-specific settings stored in database with key-value pairs

## Design Patterns in Use

- **Repository Pattern**: Database operations abstracted through functions in `db-updated.js`
- **Proxy Pattern**: API requests routed through PHP to Node.js instances
- **Observer Pattern**: WebSocket notifications for real-time chat updates
- **Factory Pattern**: Instance creation and configuration management
- **Strategy Pattern**: AI provider switching (OpenAI vs Gemini)

## Component Relationships

```
index.php (Admin Dashboard)
├── api.php (API Gateway)
│   ├── db-updated.js (Database Layer)
│   └── Node.js Instance (via cURL)
│       └── whatsapp-server-intelligent.js
├── external_auth.php (User Auth)
└── dashboard_chat.php (Chat UI)
```

## Critical Implementation Paths

1. **Instance Creation**:
   - User creates instance via web UI
   - PHP stores in database
   - Node.js process starts with Baileys authentication

2. **Message Handling**:
   - WhatsApp message received by Node.js
   - Stored in SQLite database
   - WebSocket pushes to connected clients
   - PHP serves chat interface

3. **AI Integration**:
   - Message triggers AI processing in Node.js
   - API calls to OpenAI/Gemini
   - Response sent back through WhatsApp

4. **Authentication Flow**:
   - QR code generated by Node.js
   - Displayed in PHP dashboard
   - User scans to authenticate instance